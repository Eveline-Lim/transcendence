asyncapi: 3.0.0
info:
  title: Match Service WebSocket API
  version: 1.0.1
  description: |
    Real-time WebSocket events for matchmaking.
    Handles player queuing and match creation.

servers:
  production:
    host: api.transcendence.local
    pathname: /ws/match
    protocol: wss
    description: Production WebSocket server
    security:
      - $ref: '#/components/securitySchemes/bearerAuth'
  development:
    host: localhost:8080
    pathname: /ws/match
    protocol: ws
    description: Development WebSocket server

channels:
  matchmakingChannel:
    address: matchmaking/{playerId}
    parameters:
      playerId:
        description: Player's unique identifier (UUID)
    messages:
      queueUpdate:
        $ref: '#/components/messages/QueueUpdate'
      matchFound:
        $ref: '#/components/messages/MatchFound'
      joinQueue:
        $ref: '#/components/messages/JoinQueue'
      leaveQueue:
        $ref: '#/components/messages/LeaveQueue'

operations:
  # Client to Server Operations
  sendJoinQueue:
    action: send
    channel: 
      $ref: '#/channels/matchmakingChannel'
    messages:
      - $ref: '#/channels/matchmakingChannel/messages/joinQueue'

  sendLeaveQueue:
    action: send
    channel: 
      $ref: '#/channels/matchmakingChannel'
    messages:
      - $ref: '#/channels/matchmakingChannel/messages/leaveQueue'

  # Server to Client Operations
  onQueueUpdate:
    action: receive
    channel: 
      $ref: '#/channels/matchmakingChannel'
    messages:
      - $ref: '#/channels/matchmakingChannel/messages/queueUpdate'

  onMatchFound:
    action: receive
    channel: 
      $ref: '#/channels/matchmakingChannel'
    messages:
      - $ref: '#/channels/matchmakingChannel/messages/matchFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  messages:
    # Client to Server Messages
    JoinQueue:
      name: joinQueue
      title: Join Matchmaking Queue
      contentType: application/json
      payload:
        type: object
        required:
          - event
        properties:
          event:
            type: string
            const: join_queue
          data:
            type: object
            properties:
              gameMode:
                type: string
                enum: [casual, ranked]
                default: casual

    LeaveQueue:
      name: leaveQueue
      title: Leave Matchmaking Queue
      contentType: application/json
      payload:
        type: object
        required:
          - event
        properties:
          event:
            type: string
            const: leave_queue

    # Server to Client Messages
    QueueUpdate:
      name: queueUpdate
      title: Matchmaking Queue Update
      contentType: application/json
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            const: queue_update
          data:
            type: object
            required:
              - playersWaiting
              - estimatedWaitTime
            properties:
              playersWaiting:
                type: integer
              estimatedWaitTime:
                type: integer
                description: Estimated wait time in seconds

    MatchFound:
      name: matchFound
      title: Match Found
      contentType: application/json
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            const: match_found
          data:
            type: object
            required:
              - matchId
              - gameEngineUrl
              - opponent
            properties:
              matchId:
                type: string
                format: uuid
              gameEngineUrl:
                type: string
                format: uri
                description: WebSocket URL to connect to Game Engine Service
              opponent:
                type: object
                required:
                  - username
                properties:
                  username:
                    type: string
                  avatarUrl:
                    type: string
